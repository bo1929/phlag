# Phlag
Phlag flags phylogenetic anomalies across the genome.

Given a species tree, and a sequence of gene trees, Phlag aims to detect strong deviations from the multispecies coalescent process (MSC) using quadripartition quartet scores and a hidden Markov model.
The input is simply a sequence of gene trees, ideally sampled uniformly across a chromosome.
The expected output is ``flagged'' subsequences that correspond to model violations (e.g., admixture, recombination suppression, dramatic changes in effective population size), and an updated species tree with new branch length estimates (in coalescent unit), ignoring the flagged gene trees.

## Installation

For installation, please follow the steps below, you will need Python >= 3.9 environment.
```shell
micromamba create -n phlag python=3.9 -y
micromamba activate phlag
git clone https://github.com/bo1929/phlag.git
cd phlag
pip install -r requirements.txt
./build.sh
```

## Quickstart with a toy example
Suppose we have a species tree (`test/neoaves.nwk`), and a ordered set of gene trees (`test/emission.gtrees`).
This gene tree sequence is a mixture of two coalescent with recombination processes with one difference: the effective population size for some Charadriiformes increased by 10x.
The mixture happens in a way that only certain loci is affected by this change.
In this particular example, 150 out of 1500 gene trees are generated by the alternative process.
Thus, our goal is to detect this region (starting in gene tree at index 913, and eding at index 1063) using Phlag.

### Input
- Species tree: A Newicks pecies tree with labeled internal nodes.
- Gene trees: One Newick tree per line, ordered along the genome. Labels are not for internal nodes.
- A focal branch: The label of the clade that is going to be targeted. Multiple label can be given. In this example, the clade we are suspicious of has the label `N159`.

### Usage
```shell
python phlag.py \
  --species-tree test/neoaves.nwk \
  --gene-trees  test/emission.gtrees \
  -c N159 \
  --num-ters 10 \
  --read-qqs-freqs test/qqs.tsv \
  --output-file results-neoaves-N159.txt
```
The quadripartition quartet scores are already computed and stored in `test/qqs.tsv`.
You can directly read those to avoid extra computation for this toy example.
If you do not give `--read-qqs-freqs`, QQS values need to be computed, which adds a little to the running time.
Note that, you can also save QQS values to read later for different runs (i.e., changing the focal branch or the hyperparameters) using `write-qqs-freqs`.

For other options, run `python phlag.py --help`.
Note that, your data may not have strong deviations from MSC (i.e., too few or no flagged gene trees), or you may not have a reliable or incorrect species tree (i.e., too many flagged gene trees).
In such cases, you may attempt to adjust the hyperparamters to detect anomalous gene trees at the resolution you desire.

### Output
The output is rather simple to interpret:
- The first 5 lines are commented with `#`, these are auxiliary information which you may find useful.
    * Simply the invoked command and the version information.
    * The initial species tree with branch lengths in CU, estimated using the entire gene tree sequence.
    * The same species tree topology, but branch lengths are estimated only based on the gene trees that are not flagged.
    * The labels of the clades for the focal branches that are used, and their final branch lengths.
    * Distances between the emission distributions of the two states, separately for all the focal branches following the order given in the above line.
- State label: 1 corresponds to flagged gene trees, 0 is for gene trees in compliance with MSC.
- Posterior decoding probabilities for each gene tree.
